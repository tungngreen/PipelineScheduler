syntax = "proto3";
import "google/protobuf/empty.proto";

option java_multiple_files = true;
option objc_class_prefix = "HLW";

package controlcommunication;

service ControlCommunication {
  rpc AdvertiseToController(ConnectionConfigs) returns (google.protobuf.Empty) {}
  rpc StartMicroservice(MicroserviceConfig) returns (google.protobuf.Empty) {}
  rpc UpdateDownstream(MicroserviceLink) returns (google.protobuf.Empty) {}
  rpc StopMicroservice(MicroserviceSignal) returns (google.protobuf.Empty) {}
  rpc SendDeviceState(DeviceState) returns (google.protobuf.Empty) {}
  rpc SendLightMetrics(LightMetricsList) returns (google.protobuf.Empty) {}
  rpc SendFullMetrics(FullMetricsList) returns (google.protobuf.Empty) {}
}

message ConnectionConfigs {
  string device_name = 1;
  uint32 device_type = 2;
  string ip_address = 3;
  int32 processors = 4;
  repeated uint64 memory = 5;
}

message DeviceState {
  string name = 1;
  repeated double pu_usage = 2;
  repeated double mem_usage = 3;
}

message LightMetrics {
  string name = 1;
  repeated int32 queue_size = 2;
  float request_rate = 3;
}

message LightMetricsList {
  repeated LightMetrics metrics = 1;
}

message FullMetrics {
  string name = 1;
  repeated int32 queue_size = 2;
  float request_rate = 3;
  double cpu_usage = 4;
  int64 mem_usage = 5;
  uint32 gpu_usage = 6;
  uint32 gpu_mem_usage = 7;
}

message FullMetricsList {
  repeated FullMetrics metrics = 1;
}

message Neighbor {
  string name = 1;
  string ip = 2;
  int32 class_of_interest = 3;
  bool gpu_connection = 4;
}

message MicroserviceConfig {
  string name = 1;
  int32 model = 2;
  int32 batch_size = 3;
  int32 recv_port = 4;
  int32 slo = 5;
  int32 device = 6;
  repeated Neighbor upstream = 7;
  repeated Neighbor downstream = 8;
}

message MicroserviceLink {
  string name = 1;
  string downstream_name = 2;
  string ip = 3;
  int32 port = 4;
}

message MicroserviceSignal {
  string name = 1;
  bool forced = 2;
}